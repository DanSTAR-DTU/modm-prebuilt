!!! warning "These module docs are in beta and may be incomplete."

# modm:processing:protothread: Protothreads

Protothreads are extremely lightweight stackless threads designed for
severely memory constrained systems, such as small embedded systems or
wireless sensor network nodes. Protothreads provide linear code execution
for event-driven systems implemented in C. Protothreads can be used with or
without an underlying operating system to provide blocking event-handlers.

Protothreads provide sequential flow of control without complex state
machines or full multi-threading.

Since they implement some kind of cooperative multi-threading, Protothreads
are non-preemptable. Therefore, a context switch can only take place on
blocking operations, which means you don't need complex synchronization.

Protothreads are also stackless, so local variables are not preserved across
context switches, and must instead become member variables of the
`modm::Protothread` subclass

A protothread runs within a single function (`modm::Protothread::run()`) and
cannot span over other functions. A protothread may call normal functions,
but cannot block inside a called function. Blocking inside nested function
calls is instead made by spawning a separate protothread for each
potentially blocking function.

The protothread concept was developed by Adam Dunkels and Oliver Schmidt:
http://dunkels.com/adam/pt

Originally ported to C++ for use by Hamilton Jet (www.hamiltonjet.co.nz) by
Ben Hoyt, but stripped down for public release.


## Example

```cpp
#include <modm/processing/protothread.hpp>

using Led = GpioB0;

class BlinkingLight : public modm::pt::Protothread
{
public:
    bool
    run()
    {
        PT_BEGIN();

        // set everything up
        Led::setOutput();
        Led::set();

        while (true)
        {
            timeout.restart(100);
            Led::set();
            PT_WAIT_UNTIL(timeout.isExpired());

            timeout.restart(200);
            Led::reset();
            PT_WAIT_UNTIL(timeout.isExpired());
        }

        PT_END();
    }

private:
    modm::ShortTimeout timeout;
};
// ...

BlinkingLight light;

while (1) {
    light.run();
}
```

## Content

```cpp
// Class
class modm::pt::Protothread;
class modm::pt::Semaphore;
// Define
#define PT_BEGIN
#define PT_CALL(resumable)
#define PT_END
#define PT_EXIT
#define PT_RESTART
#define PT_SPAWN(child)
#define PT_WAIT_THREAD(child)
#define PT_WAIT_UNTIL(condition)
#define PT_WAIT_WHILE(condition)
#define PT_YIELD
```
## Dependencies

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: modm:processing:protothread Pages: 1 -->
<svg width="180pt" height="224pt"
 viewBox="0.00 0.00 180.00 224.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 220)">
<title>modm:processing:protothread</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-220 176,-220 176,4 -4,4"/>
<!-- modm_processing_protothread -->
<g id="node1" class="node">
<title>modm_processing_protothread</title>
<polygon fill="#d3d3d3" stroke="#000000" stroke-width="2" points="126.5,-142 47.5,-142 47.5,-89 126.5,-89 126.5,-142"/>
<text text-anchor="middle" x="87" y="-126.8" font-family="Times,serif" font-size="14.00" fill="#000000">modm:</text>
<text text-anchor="middle" x="87" y="-111.8" font-family="Times,serif" font-size="14.00" fill="#000000">processing:</text>
<text text-anchor="middle" x="87" y="-96.8" font-family="Times,serif" font-size="14.00" fill="#000000">protothread</text>
</g>
<!-- modm_architecture -->
<g id="node2" class="node">
<title>modm_architecture</title>
<g id="a_node2"><a xlink:href="../modm-architecture" xlink:title="modm:&#10;architecture">
<polygon fill="#d3d3d3" stroke="#000000" points="80,-216 0,-216 0,-178 80,-178 80,-216"/>
<text text-anchor="middle" x="40" y="-200.8" font-family="Times,serif" font-size="14.00" fill="#000000">modm:</text>
<text text-anchor="middle" x="40" y="-185.8" font-family="Times,serif" font-size="14.00" fill="#000000">architecture</text>
</a>
</g>
</g>
<!-- modm_processing_protothread&#45;&gt;modm_architecture -->
<g id="edge1" class="edge">
<title>modm_processing_protothread&#45;&gt;modm_architecture</title>
<path fill="none" stroke="#000000" d="M71.6104,-142.1861C66.643,-150.7999 61.1245,-160.3692 56.1067,-169.0703"/>
<polygon fill="#000000" stroke="#000000" points="53.0668,-167.3357 51.103,-177.7469 59.1307,-170.8327 53.0668,-167.3357"/>
</g>
<!-- modm_processing -->
<g id="node3" class="node">
<title>modm_processing</title>
<g id="a_node3"><a xlink:href="../modm-processing" xlink:title="modm:&#10;processing">
<polygon fill="#d3d3d3" stroke="#000000" points="172,-216 98,-216 98,-178 172,-178 172,-216"/>
<text text-anchor="middle" x="135" y="-200.8" font-family="Times,serif" font-size="14.00" fill="#000000">modm:</text>
<text text-anchor="middle" x="135" y="-185.8" font-family="Times,serif" font-size="14.00" fill="#000000">processing</text>
</a>
</g>
</g>
<!-- modm_processing_protothread&#45;&gt;modm_processing -->
<g id="edge2" class="edge">
<title>modm_processing_protothread&#45;&gt;modm_processing</title>
<path fill="none" stroke="#000000" d="M102.717,-142.1861C107.7901,-150.7999 113.426,-160.3692 118.5506,-169.0703"/>
<polygon fill="#000000" stroke="#000000" points="115.5701,-170.9065 123.6608,-177.7469 121.6017,-167.3541 115.5701,-170.9065"/>
</g>
<!-- modm_driver_bme280 -->
<g id="node4" class="node">
<title>modm_driver_bme280</title>
<g id="a_node4"><a xlink:href="../modm-driver-bme280" xlink:title="modm:&#10;driver:&#10;bme280">
<polygon fill="#d3d3d3" stroke="#000000" points="117.5,-53 56.5,-53 56.5,0 117.5,0 117.5,-53"/>
<text text-anchor="middle" x="87" y="-37.8" font-family="Times,serif" font-size="14.00" fill="#000000">modm:</text>
<text text-anchor="middle" x="87" y="-22.8" font-family="Times,serif" font-size="14.00" fill="#000000">driver:</text>
<text text-anchor="middle" x="87" y="-7.8" font-family="Times,serif" font-size="14.00" fill="#000000">bme280</text>
</a>
</g>
</g>
<!-- modm_driver_bme280&#45;&gt;modm_processing_protothread -->
<g id="edge3" class="edge">
<title>modm_driver_bme280&#45;&gt;modm_processing_protothread</title>
<path fill="none" stroke="#000000" d="M87,-53.2029C87,-61.2113 87,-70.1403 87,-78.6802"/>
<polygon fill="#000000" stroke="#000000" points="83.5001,-78.8159 87,-88.8159 90.5001,-78.8159 83.5001,-78.8159"/>
</g>
</g>
</svg>

